<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Smart Weather Route Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      direction: rtl;
      padding: 0;
      margin: 0;
      background: linear-gradient(to bottom right, #ffffff, #ffffff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .main-card {
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      width: 95%;
      max-width: 1200px;
      padding: 2rem;
      box-sizing: border-box;
    }
    #map { height: 450px; border-radius: 12px; overflow: hidden; margin-top: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
    .container { padding: 0; max-width: none; margin: auto; }
    .cards { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; justify-content: center; }
    .card {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 1rem;
      flex: 1 1 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      background:#fff;
      position: relative;
      transition: transform 0.2s ease-in-out;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .alert-log { margin-top: 1.5rem; background-color: #f8f8f8; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .alert-item { background: #fff5f5; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 5px solid #e53e3e; }
    .summary { background: #e8f4ff; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 500; border: 1px solid #cce0ff; }
    .highlight { font-weight: bold; color: #1e40af; }
    .risk-badge { padding: 6px 14px; border-radius: 20px; color: #fff; font-size: 0.85rem; display:inline-block; font-weight: 600; }
    .risk-low { background: #facc15; }
    .risk-medium { background: #fb923c; }
    .risk-high { background: #ef4444; }
    .alert-source { font-size: 0.7rem; color: #6b7280; margin-top: 4px; }
    .flex-inputs { display:flex; gap:1.5rem; flex-wrap: wrap; align-items:flex-end; }
    .small { font-size:0.9rem; }
    input[type="text"], input[type="datetime-local"], select {
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus, input[type="datetime-local"]:focus, select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
      outline: none;
    }
    label {
      font-size: 0.95rem;
      color: #4b5563;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      font-weight: 500;
    }
    label i {
      margin-left: 8px;
      color: #3b82f6;
    }
    #planBtn {
      padding: 12px 24px;
      border: none;
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color:#fff;
      border-radius: 8px;
      cursor:pointer;
      font-size: 1.1rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out;
    }
    #planBtn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    #loadingIndicator {
        display: none;
        text-align: center;
        margin-top: 1.5rem;
        font-weight: bold;
        color: #3182ce;
        font-size: 1.1rem;
    }
    .error-message {
        color: #ef4444;
        margin-top: 1.5rem;
        font-weight: bold;
        text-align: center;
        font-size: 1.1rem;
        background-color: #fee2e2;
        border: 1px solid #fca5a5;
        padding: 1rem;
        border-radius: 8px;
    }
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1e40af;
      text-align: center;
      margin-bottom: 2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
    }
    h2 {
      font-size: 1.8rem;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 1rem;
      border-bottom: 2px solid #bfdbfe;
      padding-bottom: 0.5rem;
    }
    ul { list-style: none; padding: 0; }
    ul li { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="main-card">
    <h1><i class="fas fa-plane-departure ml-3"></i> مخطط رحلات الطقس الذكي</h1>

    <div class="flex-inputs">
      <div style="flex: 1 1 250px;">
        <label for="start_city"><i class="fas fa-map-marker-alt"></i> مدينة البداية:</label>
        <select id="start_city" class="bg-white">
            <option value="">اختر مدينة</option>
            <option value="جدة">جدة</option>
            <option value="الرياض">الرياض</option>
            <option value="الدمام">الدمام</option>
            <option value="مكة المكرمة">مكة المكرمة</option>
            <option value="المدينة المنورة">المدينة المنورة</option>
            <option value="الطائف">الطائف</option>
            <option value="أبها">أبها</option>
            <option value="تبوك">تبوك</option>
            <option value="بريدة">بريدة</option>
        </select>
      </div>
      <div style="flex: 1 1 250px;">
        <label for="end_city"><i class="fas fa-map-marker-alt"></i> مدينة النهاية:</label>
        <select id="end_city" class="bg-white">
            <option value="">اختر مدينة</option>
            <option value="جدة">جدة</option>
            <option value="الرياض">الرياض</option>
            <option value="الدمام">الدمام</option>
            <option value="مكة المكرمة">مكة المكرمة</option>
            <option value="المدينة المنورة">المدينة المنورة</option>
            <option value="الطائف">الطائف</option>
            <option value="أبها">أبها</option>
            <option value="تبوك">تبوك</option>
            <option value="بريدة">بريدة</option>
        </select>
      </div>
      <div style="flex: 1 1 250px;">
        <label for="departure"><i class="fas fa-clock"></i> وقت المغادرة:</label>
        <input id="departure" type="datetime-local" />
      </div>
      <div style="flex-shrink: 0; margin-top: 1rem;">
        <button id="planBtn"><i class="fas fa-route ml-2"></i> خطط الرحلة</button>
      </div>
    </div>

    <div id="loadingIndicator">جاري تخطيط الرحلة... <i class="fas fa-spinner fa-spin"></i></div>
    <div id="errorMessage" class="error-message"></div>

    <div id="routeSummary" class="summary" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
        <div class="text-lg font-semibold text-gray-800">ملخص عام للمسار</div>
        <div class="risk-badge" id="overallRiskBadge"></div>
      </div>
      <div id="routeSummaryText" class="small text-gray-700 mt-2"></div>
    </div>

    <div id="map"></div>
    
    <div style="margin-top:2rem;">
      <h2><i class="fas fa-cloud-sun"></i> توقعات الطقس على طول المسار</h2>
      <div class="cards" id="weatherCardsContainer"></div>
    </div>

    <div style="margin-top:2rem;">
      <h2><i class="fas fa-exclamation-triangle"></i> سجل الإنذارات</h2>
      <div id="alertsLog" class="alert-log"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        document.getElementById('departure').value = `${year}-${month}-${day}T${hours}:${minutes}`;
    });

    const riskColor = (level) => {
      if (!level) return '';
      const l = level.toLowerCase();
      if (l.includes('عالي') || l.includes('high')) return 'risk-high';
      if (l.includes('متوسط') || l.includes('moderate')) return 'risk-medium';
      if (l.includes('منخفض') || l.includes('low')) return 'risk-low';
      return '';
    };

    const map = L.map("map").setView([23.5, 45], 6);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap",
    }).addTo(map);

    let markersGroup = L.layerGroup().addTo(map);
    let routeLayer = null;

    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessageDiv = document.getElementById('errorMessage');
    const routeSummaryDiv = document.getElementById('routeSummary');
    const overallRiskBadge = document.getElementById('overallRiskBadge');
    const routeSummaryText = document.getElementById('routeSummaryText');
    const weatherCardsContainer = document.getElementById('weatherCardsContainer');
    const alertsLogDiv = document.getElementById('alertsLog');


    document.getElementById("planBtn").addEventListener("click", async () => {
      errorMessageDiv.textContent = '';
      loadingIndicator.style.display = 'block';
      routeSummaryDiv.style.display = 'none';
      weatherCardsContainer.innerHTML = '';
      alertsLogDiv.innerHTML = '';

      const startCity = document.getElementById("start_city").value;
      const endCity = document.getElementById("end_city").value;
      const departure = document.getElementById("departure").value;

      if (!startCity || !endCity || !departure) {
        errorMessageDiv.textContent = "الرجاء إدخال جميع بيانات مدينة البداية والنهاية ووقت المغادرة.";
        loadingIndicator.style.display = 'none';
        return;
      }
      if (startCity === endCity) {
        errorMessageDiv.textContent = "يجب أن تكون مدينة البداية والنهاية مختلفتين.";
        loadingIndicator.style.display = 'none';
        return;
      }

      const payload = {
        start_city: startCity,
        end_city: endCity,
        departure_time: new Date(departure).toISOString()
      };

      try {
        const res = await fetch("https://your-service-name.onrender.com/plan_travel_weather_route", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errorBody = await res.text();
          let detailedError = `HTTP error! status: ${res.status}`;
          try {
              const errorJson = JSON.parse(errorBody);
              detailedError = errorJson.detail || detailedError;
          } catch (parseError) {
              detailedError = errorBody || detailedError;
          }
          throw new Error(detailedError);
        }
        const data = await res.json();
        displayResult(data);
      } catch (e) {
        console.error("Fetch error:", e);
        errorMessageDiv.textContent = "فشل الاتصال بالخادم أو في البيانات: " + e.message;
      } finally {
        loadingIndicator.style.display = 'none';
      }
    });

    function displayResult(data) {
      errorMessageDiv.textContent = '';
      routeSummaryDiv.style.display = 'block';
      routeSummaryText.textContent = data.route_summary || "";
      overallRiskBadge.className = `risk-badge ${riskColor(data.overall_risk)}`;
      overallRiskBadge.textContent = data.overall_risk;
      
      if (routeLayer) map.removeLayer(routeLayer);
      if (data.route_map && data.route_map.features && data.route_map.features.length > 0) {
        routeLayer = L.geoJSON(data.route_map, { style: { color: "#1e40af", weight: 5, opacity: 0.7 } }).addTo(map);
        map.fitBounds(routeLayer.getBounds(), { padding: [50,50] });
      } else {
        errorMessageDiv.textContent = "لم يتم العثور على مسار صالح لهذه المدن. يرجى التحقق من أسماء المدن.";
        map.setView([23.5, 45], 6);
      }

      markersGroup.clearLayers();
      weatherCardsContainer.innerHTML = "";
      alertsLogDiv.innerHTML = "";

      if (data.weather_along_route && data.weather_along_route.length > 0) {
        data.weather_along_route.forEach(pointData => {
          if (pointData.error) {
            console.error("Error for point:", pointData.error);
            return; 
          }
          const card = document.createElement('div');
          card.className = 'card';
          
          const time = new Date(pointData.arrival_time).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
          const locationName = pointData.location_name || 'نقطة على الطريق';

          const summary = pointData.forecast_card;
          const riskLevel = pointData.unified_risk;

          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
              <div class="text-xl font-semibold text-gray-800">${locationName}</div>
              <div class="risk-badge ${riskColor(riskLevel)}">${riskLevel}</div>
            </div>
            <div class="small text-gray-500 mb-2">الوقت المقدر: <span class="font-bold">${time}</span></div>
            <div class="small text-gray-700">
                <i class="fas fa-temperature-three-quarters ml-1"></i> الحرارة: <span class="font-bold">${summary?.temperature || '-'}</span>
            </div>
            <div class="small text-gray-700 mt-1">
                <i class="fas fa-cloud-showers-heavy ml-1"></i> أمطار: <span class="font-bold">${summary?.precipitation || '-'}</span>
            </div>
            <div class="small text-gray-700 mt-1">
                <i class="fas fa-wind ml-1"></i> الرياح: <span class="font-bold">${summary?.wind_speed || '-'}</span>
            </div>
          `;
          weatherCardsContainer.appendChild(card);
        });
      } else {
        weatherCardsContainer.innerHTML = '<div class="text-center text-gray-500">لا توجد بيانات طقس متاحة للمسار.</div>';
      }

      if (data.alerts_log && data.alerts_log.length > 0) {
        const uniqueAlerts = Array.from(new Set(data.alerts_log.map(JSON.stringify))).map(JSON.parse);
        uniqueAlerts.forEach(a => {
          const alertDiv = document.createElement("div");
          alertDiv.className = "alert-item";
          alertDiv.innerHTML = `
            <div><strong>إنذار:</strong> ${a.message}</div>
            <div class="small">
              الموقع: <span class="font-bold">${a.location_name || 'غير محدد'}</span> |
              المصدر: ${a.source} |
              المستوى: <span class="risk-badge ${riskColor(a.level)}">${a.level}</span>
            </div>
          `;
          alertsLogDiv.appendChild(alertDiv);
        });
      } else {
        alertsLogDiv.innerHTML = '<div class="text-center text-gray-500">لا توجد إنذارات للمسار.</div>';
      }
    }
  </script>
</body>
</html>